<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sensor Mata AI</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-landmarks-detection"></script>
    <style>
        body { background: #ffffff; color: #333; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        .box { position: relative; width: 320px; height: 240px; border-radius: 12px; overflow: hidden; background: #000; }
        video, canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: scaleX(-1); }
        #status { margin-top: 15px; font-size: 20px; font-weight: bold; font-family: monospace; }
        .hijau { color: #2ecc71; }
        .merah { color: #e74c3c; }
    </style>
</head>
<body>

    <div class="box">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
    </div>
    <div id="status">Loading sensor...</div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const statusDiv = document.getElementById('status');

        async function startApp() {
            // 1. Minta izin kamera
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            
            // 2. Load model pendeteksi wajah
            const model = await faceLandmarksDetection.load(
                faceLandmarksDetection.SupportedPackages.mediapipeFacemesh
            );
            
            statusDiv.innerText = "eye:terdeteksi";

            function detect() {
                model.estimateFaces({ input: video }).then(faces => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    if (faces.length > 0) {
                        const points = faces[0].scaledMesh;

                        // 3. Gambar garis-garis sensor di muka
                        ctx.fillStyle = "#00ff00";
                        points.forEach(p => {
                            ctx.beginPath();
                            ctx.arc(p[0], p[1], 0.5, 0, 2 * Math.PI);
                            ctx.fill();
                        });

                        // 4. Logika Merem vs Melek
                        const top = points[159][1]; 
                        const bot = points[145][1];
                        const gap = bot - top;

                        if (gap < 3.8) {
                            statusDiv.innerText = "eye:tertutup";
                            statusDiv.className = "merah";
                        } else {
                            statusDiv.innerText = "eye:terbuka";
                            statusDiv.className = "hijau";
                        }
                    }
                    requestAnimationFrame(detect);
                });
            }
            detect();
        }

        video.onloadedmetadata = () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            startApp();
        };
    </script>
</body>
</html>
